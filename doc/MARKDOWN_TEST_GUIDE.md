# Markdown 渲染功能测试指南

## 问题修复

### 问题描述
应用在发送消息时崩溃,错误信息:
```
java.lang.NoSuchMethodError: No static method getCurrentCompositeKeyHashCode
```

### 根本原因
- **Compose BOM 版本过旧**: 项目使用的 `2024.09.00` 版本与 Kotlin 2.1.0 和新的 Markdown 渲染库不兼容
- **API 不匹配**: Markdown 库使用了较新的 Compose 运行时 API,而旧版本的 Compose 不包含这些 API

### 解决方案
升级到最新的 Compose BOM 版本:
- **从**: `2024.09.00`
- **到**: `2025.12.00`
- **同时升级**: `activity-compose` 从 `1.8.0` 到 `1.9.3`

### 技术栈最终版本
```toml
[versions]
kotlin = "2.1.0"
ksp = "2.1.0-1.0.29"
composeBom = "2025.12.00"
activityCompose = "1.9.3"
room = "2.7.1"
markdownRenderer = "0.38.1"
coil = "3.0.4"
```

## 测试步骤

### 1. 基础功能测试

#### 1.1 纯文本消息
**操作**: 发送简单的文本消息
```
你好,请问现在几点了?
```
**预期**: 消息正常显示,无崩溃

#### 1.2 包含标题的消息
**操作**: 向 LLM 请求带标题的回复
```
请用 Markdown 格式介绍 Python,包含主标题和几个副标题
```
**预期**: 标题应有明显的大小层级区分

### 2. Markdown 语法测试

#### 2.1 文本样式测试
**测试提示词**:
```
请用以下 Markdown 样式回复:
1. **这是粗体文本**
2. *这是斜体文本*
3. `这是行内代码`
4. ~~这是删除线~~
```
**预期**:
- 粗体文本应加粗显示
- 斜体文本应倾斜显示
- 行内代码应有独特的背景色和等宽字体
- 删除线文本应有横线穿过

#### 2.2 列表测试
**测试提示词**:
```
请用 Markdown 创建一个无序列表和一个有序列表
```
**预期**:
- 无序列表有正确的圆点标记
- 有序列表有正确的数字标记
- 嵌套列表有适当的缩进

#### 2.3 代码块测试
**测试提示词**:
```
请写一个 Python 函数来计算斐波那契数列,使用代码块格式
```
**预期**:
- 代码块应有明显的背景色区分
- 使用等宽字体
- 保持正确的缩进
- 可能有基础的语法高亮

#### 2.4 引用块测试
**测试提示词**:
```
请用引用块格式回复一句名言
```
**预期**:
- 引用块有左侧边框或独特的背景
- 文本有适当的缩进

#### 2.5 链接测试
**测试提示词**:
```
请提供几个学习编程的网站链接,使用 Markdown 格式
```
**预期**:
- 链接应显示为可点击的文本(蓝色或主题色)
- 点击链接应能打开浏览器

#### 2.6 混合内容测试
**测试提示词**:
```
请用 Markdown 格式详细介绍 Jetpack Compose,包括:
1. 一个 H1 主标题
2. 几个 H2 和 H3 子标题
3. 包含粗体和斜体的描述段落
4. 一个特性列表(无序)
5. 一个简单的 Kotlin 代码示例
6. 一段引用
```
**预期**: 所有元素正确渲染,层次清晰

### 3. 主题兼容性测试

#### 3.1 浅色主题测试
**操作**:
1. 进入设置界面
2. 选择"浅色"主题
3. 返回聊天界面
4. 发送包含 Markdown 的消息

**预期**:
- 所有 Markdown 元素在浅色主题下清晰可读
- 代码块背景与消息气泡背景有明显区分
- 链接颜色符合浅色主题配色

#### 3.2 深色主题测试
**操作**:
1. 进入设置界面
2. 选择"深色"主题
3. 返回聊天界面
4. 发送包含 Markdown 的消息

**预期**:
- 所有 Markdown 元素在深色主题下清晰可读
- 文字与背景对比度良好
- 代码块在深色主题下有适当的背景色

#### 3.3 跟随系统主题测试
**操作**:
1. 设置为"跟随系统"
2. 切换系统主题(浅色/深色)
3. 观察 Markdown 渲染效果

**预期**: 主题切换后 Markdown 渲染自动适配

### 4. 流式响应测试

#### 4.1 流式输出 Markdown
**操作**: 发送一个会触发长回复的问题
```
请详细介绍 Android 开发的架构模式,包括 MVC、MVP、MVVM,使用 Markdown 格式
```

**预期**:
- Markdown 内容在流式输出时实时渲染
- 渲染过程流畅,无明显卡顿
- 最终渲染结果完整准确

#### 4.2 流式输出代码块
**操作**: 请求 LLM 生成较长的代码
```
请写一个完整的 Android ViewModel 示例,包含状态管理和网络请求
```

**预期**:
- 代码块在流式输出时正确显示
- 代码格式保持正确
- 语法高亮(如果支持)正常工作

### 5. 边界情况测试

#### 5.1 空消息测试
**操作**: 发送空字符串
**预期**: 不崩溃,可能显示空气泡或提示

#### 5.2 超长消息测试
**操作**: 请求非常长的回复
```
请详细介绍 Kotlin 语言的所有特性,越详细越好
```
**预期**:
- 消息能够正常滚动查看
- 渲染性能良好
- 不出现内存问题

#### 5.3 特殊字符测试
**操作**: 发送包含特殊字符的消息
```
请解释这些符号的含义: <>, &, ", ', \, *, #, `
```
**预期**: 特殊字符正确转义和显示

#### 5.4 不完整 Markdown 测试
**操作**: 发送格式不完整的 Markdown
```
**这是未闭合的粗体
*这是未闭合的斜体
```code
未闭合的代码块
```
**预期**: 应优雅降级,不崩溃

### 6. 性能测试

#### 6.1 快速切换对话
**操作**:
1. 创建多个对话
2. 在对话之间快速切换
3. 每个对话包含大量 Markdown 消息

**预期**:
- 切换流畅,无明显延迟
- 内存使用稳定
- 不出现渲染错误

#### 6.2 滚动性能测试
**操作**:
1. 在一个对话中生成大量消息
2. 快速滚动消息列表

**预期**:
- 滚动流畅,无卡顿
- Markdown 渲染不影响滚动性能

### 7. 错误恢复测试

#### 7.1 网络异常测试
**操作**:
1. 在流式响应过程中断网
2. 观察应用行为

**预期**:
- 应用不崩溃
- 显示错误提示
- 已接收的部分能正确渲染

#### 7.2 应用重启测试
**操作**:
1. 发送包含 Markdown 的消息
2. 强制停止应用
3. 重新启动应用
4. 加载历史对话

**预期**:
- 历史消息中的 Markdown 正确渲染
- 数据完整性保持

## 测试检查清单

- [ ] 基础文本消息正常显示
- [ ] H1-H6 标题正确渲染
- [ ] 粗体、斜体、删除线正常显示
- [ ] 行内代码有独特样式
- [ ] 代码块正确渲染,格式保持
- [ ] 有序列表和无序列表正确显示
- [ ] 引用块有明显标识
- [ ] 链接可点击且样式正确
- [ ] 浅色主题下渲染正常
- [ ] 深色主题下渲染正常
- [ ] 跟随系统主题工作正常
- [ ] 流式响应时 Markdown 实时渲染
- [ ] 长消息滚动流畅
- [ ] 特殊字符正确处理
- [ ] 不完整 Markdown 优雅降级
- [ ] 网络异常时应用稳定
- [ ] 应用重启后历史消息正确显示
- [ ] 整体性能良好,无明显卡顿

## 已知问题与限制

1. **图片渲染**: 需要网络连接,离线时图片不显示
2. **语法高亮**: 基础支持,可能不如专业编辑器丰富
3. **表格**: 在小屏幕上可能需要横向滚动
4. **数学公式**: 当前不支持 LaTeX 公式渲染

## 性能基准

- **普通文本消息**: < 16ms 渲染时间
- **中等 Markdown (5-10 个元素)**: < 50ms 渲染时间
- **复杂 Markdown (>20 个元素)**: < 100ms 渲染时间
- **内存占用**: 相比纯文本增加 < 5%

---

*测试指南版本: 1.0*
*最后更新: 2025-12-06*
